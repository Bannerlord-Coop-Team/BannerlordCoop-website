<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" as="font" href="https://thomasdelaporte.github.io/BannerlordCoop-website/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="https://thomasdelaporte.github.io/BannerlordCoop-website/fonts/vendor/jost/jost-v4-latin-700.woff2"  type="font/woff2" crossorigin>


<link rel="stylesheet" href="https://thomasdelaporte.github.io/BannerlordCoop-website/main.css">



  
  
    
  

  
  
    
    
  
  
  
    
  
  
  
  
    
  
  
  


  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">


	


	

<title>Battles architecture | Bannerlord Coop</title>
<meta name="description" content="The Bannerlord Coop Campaign will bring you a truly sandbox campaign, allowing every player to be on their own and act on their own.">
<link rel="canonical" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/">










<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://thomasdelaporte.github.io/BannerlordCoop-website/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Docs",
            "item": "https://thomasdelaporte.github.io/BannerlordCoop-website/docs/"
          },
        
      
        
        
        
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Main Concepts",
            "item": "https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/"
          },
        
      
        
        
        
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  4 ,
            "name": "Battles Architecture",
            "item": "https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/"
          },
        
      
    
  }
</script>






  <meta name="theme-color" content="#fff">
  <link rel="apple-touch-icon" sizes="180x180" href="https://thomasdelaporte.github.io/BannerlordCoop-website/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://thomasdelaporte.github.io/BannerlordCoop-website/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://thomasdelaporte.github.io/BannerlordCoop-website/favicon-16x16.png">
  
    <link rel="manifest" href="https://thomasdelaporte.github.io/BannerlordCoop-website/site.webmanifest" crossorigin>
  


  

</head>

  

<body class="docs single">
  
  
  
  
<div class="header-bar fixed-top"></div>
<header class="navbar fixed-top navbar-expand-md navbar-light">
	<div class="container">
		<input class="menu-btn order-0" type="checkbox" id="menu-btn">
		<label class="menu-icon d-md-none" for="menu-btn"><span class="navicon"></span></label>
		<a class="navbar-brand order-1 order-md-0 me-auto" href="https://thomasdelaporte.github.io/BannerlordCoop-website/">Bannerlord Coop</a>
		
		<button id="mode" class="btn btn-link order-2 order-md-4" type="button" aria-label="Toggle mode">
			<span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
			<span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
		</button>

		<ul class="navbar-nav fork-me order-3 order-md-5">
			
				
					<li class="nav-item">
						<a class="nav-link" href="//discord.gg/VXqGyT8" target="_blank"><svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M19.54 0c1.356 0 2.46 1.104 2.46 2.472v21.528l-2.58-2.28-1.452-1.344-1.536-1.428.636 2.22h-13.608c-1.356 0-2.46-1.104-2.46-2.472v-16.224c0-1.368 1.104-2.472 2.46-2.472h16.08zm-4.632 15.672c2.652-.084 3.672-1.824 3.672-1.824 0-3.864-1.728-6.996-1.728-6.996-1.728-1.296-3.372-1.26-3.372-1.26l-.168.192c2.04.624 2.988 1.524 2.988 1.524-1.248-.684-2.472-1.02-3.612-1.152-.864-.096-1.692-.072-2.424.024l-.204.024c-.42.036-1.44.192-2.724.756-.444.204-.708.348-.708.348s.996-.948 3.156-1.572l-.12-.144s-1.644-.036-3.372 1.26c0 0-1.728 3.132-1.728 6.996 0 0 1.008 1.74 3.66 1.824 0 0 .444-.54.804-.996-1.524-.456-2.1-1.416-2.1-1.416l.336.204.048.036.047.027.014.006.047.027c.3.168.6.3.876.408.492.192 1.08.384 1.764.516.9.168 1.956.228 3.108.012.564-.096 1.14-.264 1.74-.516.42-.156.888-.384 1.38-.708 0 0-.6.984-2.172 1.428.36.456.792.972.792.972zm-5.58-5.604c-.684 0-1.224.6-1.224 1.332 0 .732.552 1.332 1.224 1.332.684 0 1.224-.6 1.224-1.332.012-.732-.54-1.332-1.224-1.332zm4.38 0c-.684 0-1.224.6-1.224 1.332 0 .732.552 1.332 1.224 1.332.684 0 1.224-.6 1.224-1.332 0-.732-.54-1.332-1.224-1.332z"/></svg><span class="ms-2 visually-hidden">Discord</span></a>
					</li>
				
			
		</ul>
		<div class="collapse navbar-collapse order-4 order-md-1">
			<ul class="navbar-nav main-nav me-auto order-5 order-md-2">
				
					
				
				
				
					
						<li class="nav-item docs active">
							<a class="nav-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/getting-started/introduction/">Docs</a>
						</li>
					
						<li class="nav-item">
							<a class="nav-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/faq/">FAQ</a>
						</li>
					
				
			</ul>
			<div class="break order-6 d-md-none"></div>
			
				<form class="navbar-form flex-grow-1 order-7 order-md-3">
					<input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
						aria-label="Search docs..." autocomplete="off">
					<div id="suggestions" class="shadow bg-white rounded"></div>
				</form>
			
		</div>
	</div>
</header>



  
<div class="wrap container" role="document">
  <div class="content">
    <div class="row flex-xl-nowrap">
	  
<div class="col-lg-5 col-xl-4 docs-sidebar">
	<nav class="docs-links" aria-label="Main navigation">
		
		

		

		
			
				
				

				

					
						
					
						
					
						
					

					<h3 class="docs-sidebar__title docs-sidebar__title--open" role="button">Getting Started</h3>
					
					<ul class="collapse list-unstyled show ">
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/getting-started/introduction/">Introduction</a></li>
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/getting-started/quick-start/">Quick Start</a></li>
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/getting-started/how-to-contribute/">How to Contribute</a></li>
						

						
					</ul>
				
			
				
				

				

					
						
					
						
					
						
					
						
					

					<h3 class="docs-sidebar__title" role="button">Bannerlord modding</h3>
					
					<ul class="collapse list-unstyled ">
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/bannerlord-modding/mod-loading/">How mods are loaded</a></li>
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/bannerlord-modding/patching/">Patching (Harmony)</a></li>
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/bannerlord-modding/reading/">Reading</a></li>
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/bannerlord-modding/reflection/">Reflection</a></li>
						

						
							
								<li><a class="docs-link" href="https://docs.bannerlordmodding.com/" target="_blank">ðŸ“– More documentation</a></li>
							
						
					</ul>
				
			
				
				

				

					
						
					
						
							
							

					<h3 class="docs-sidebar__title docs-sidebar__title--open" role="button">Main concepts</h3>
					
					<ul class="collapse list-unstyled show ">
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/architecture/">Architecture</a></li>
						                           
							<li><a class="docs-link active" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/">Battles architecture</a></li>
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/syncing/">Syncing</a></li>
						

						
					</ul>
				
			
				
				

				

					
						
					

					<h3 class="docs-sidebar__title" role="button">Debug &#x2F; Testing</h3>
					
					<ul class="collapse list-unstyled ">
						                           
							<li><a class="docs-link" href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/debug-testing/debugging-game/">Debugging tools</a></li>
						

						
					</ul>
				
			
		
	</nav>
</div>

	  
  
  <nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation">
  	<div class="page-links">
  			<h3>On this page</h3>
  			<nav id="TableOfContents">
  					<ul>
  							
  							<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#server-architecture">Server Architecture</a></li>
  							
  									<ul>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#overview">Overview</a></li>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#encounters">Encounters</a></li>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#notable-places">Notable Places</a></li>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#battles-scenes">Battles&#x2F;Scenes</a></li>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#battle-results">Battle Results</a></li>
  											
  									</ul>
  							
  							
  							<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#character-synchronization">Character Synchronization</a></li>
  							
  									<ul>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#movements">Movements</a></li>
  											
  											<li><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/docs/main-concepts/battles-architecture/#events-actions">Events&#x2F;Actions</a></li>
  											
  									</ul>
  							
  							
  					</ul>
  			</nav>
  	</div>
  </nav>
  

      <main class="docs-content col-lg-11 col-xl-9">
        <h1>Battles architecture</h1>
        <p class="lead">To manage state synchronization, we use the Railgun library as follows.</p>
        <h2 id="server-architecture">Server Architecture</h2>
<h3 id="overview">Overview</h3>
<p>The server is responsible for efficiently providing multi-agent syncing for battles, places players can visit, and the output of said battles. The server would need to provide real time synchronization for a total of floor(N / 2) places where N is the number of players in a server. For example, in a server where there are 7 people, sync would only happen when 2+ people are in a battle. Thus, assuming worst case, we would have 3 1v1, and 1 idle player. This would verifies that floor(7/2) = 3. In a server architecture, a single instance of a server can technically handle all the clients on 1 process. This allows for the server to be scaled horizontally rather than vertically. Here is a diagram that describes the process: ServerArchitecture The server keeps track of 3 distinct things:</p>
<p><img src="/battle_architecture.png" alt="Battle server architecture" /></p>
<ol>
<li>Unique battles IDs</li>
<li>Unique client IDs</li>
<li>Notable Place IDs (static)</li>
</ol>
<ul>
<li>Client ID maps to a Battle ID</li>
<li>Battle ID maps to a list of Client IDs</li>
<li>Notable Place IDs loaded from the server. Clients are expected to send the correct ID.</li>
</ul>
<h3 id="encounters">Encounters</h3>
<p>Players can encounter other players on the map, or players that are in a battle with AI. These are custom encounters that need to be generated, and the interactions between the players are specific. For the initial release, encounters with players in battles (to reinforce or fight against) could be disabled. Such encounters need to be limited to prevent grieving; in the case where a player might interrupt another player and keep the dialog open, or the player constantly interacts with another player. This is true for notable places as well.</p>
<h4 id="player-npc-player-interaction">Player, NPC, Player Interaction</h4>
<p>In the case where a player runs into an NPC (say a lord), an encounter is created. This encounter will be associated with the player that initiated it. No server syncing is needed so far. If another player decides to join this encounter before a battle start, they can. This will lead to a custom encounter for the joining player. The joining player can choose which side to help and wait for the player that created the encounter to start the battle. The custom encounter ensures the joining player waits for the other player to start the battle or cancel the encounter all together. The joining player will send the following message to the server.</p>
<p><code>MessageType | PartySideToJoin | Num of Encountered Lords | List of Encounter Lords IDs</code></p>
<h4 id="player-player-interaction">Player, Player Interaction</h4>
<p>Player/Player interaction is a custom interaction that will result in an encounter. The server will load the characterâ€™s data, and show each player two options:</p>
<ol>
<li>Offer to Trade</li>
<li>Battle!</li>
</ol>
<h3 id="notable-places">Notable Places</h3>
<p>Notable places get loaded from the serverâ€™s game instance. Each notable place is a pair of IDs. One that describes the location on the map, and the second describes a place in that location. Example: (Sargot, Arena) or (Charas, Tavern) When a player visit an Arena, the values get sent as follows:</p>
<p><code>MessageType | ClientI | LocationPlacePair</code></p>
<p>This lets the server know someone visited a notable place. The server will add this client to a list and check if the # of clients for the LocationPlacePair is &gt; 1. If yes, the server will send updates of the other client(s) to each other.</p>
<h3 id="battles-scenes">Battles/Scenes</h3>
<p>One client asks to battle another client
Server generates a batteID, and based on their location, a scene ID.</p>
<p>The server passes the following tuples to each client:<br />
<code>BatteID | SceneID</code></p>
<p>Each client will spawn its troops, then send the data about each agent to the server:<br />
<code>BatteID | SceneID | ListOfAgenet</code></p>
<p>List of Agents will contain the following:<br />
<code>AgentIndex | AgentVisuals</code></p>
<p>The server will keep a mapping between an internal index and the clientâ€™s index. For any client, the other clients first agent index will start from be CLIENT_A_LAST_INDEX + 1 and will end at CLIENT_A_LAST_INDEX + CLIENT_B_COUNT. Thus if client A sends an update for its second agent movement, it would be AGENTS[CLIENT_A_LAST_INDEX + 2]. The server will keep an internal order of parties and perform these conversions before sending updates.</p>
<h3 id="battle-results">Battle Results</h3>
<p>TBD</p>
<h2 id="character-synchronization">Character Synchronization</h2>
<h3 id="movements">Movements</h3>
<p>Character movements will be sent to the server at n ticks. Each client will send the information about its main hero and all its units. The server will verify this information and pass it back to all clients If the location doesnâ€™t make sense, the server will teleport the player/character to its last known location.</p>
<h3 id="events-actions">Events/Actions</h3>
<p>When a character swings, the swing is sent to the server. If the client claims the swing did damage, the damage information will be sent to the server for verification. If it passes, the damage will be registered and sent to all the clients. Therefore, all actions that cause feedback (swing, release arrow, block) need to be animated and not actual actions that cause any change. The change will be supplied by the server and applied to all clients. If it doesnâ€™t no damage will be recorded on any of the clients. Events need guarantee of arrival (unlike movement) so a reliable UDP connection is required. An example of events / actions:</p>
<p><code>ActionType | AgentID | AgentLocationDirection</code></p>

        
        
<div class="docs-navigation d-flex justify-content-between">
  
  
  
  
  
  <a href="https:&#x2F;&#x2F;thomasdelaporte.github.io&#x2F;BannerlordCoop-website&#x2F;docs&#x2F;main-concepts&#x2F;architecture&#x2F;">
    <div class="card my-1">
      <div class="card-body py-2">
        &larr; Architecture
      </div>
    </div>
  </a>
  

  
  
  
  
  
    <a class="ms-auto" href="https:&#x2F;&#x2F;thomasdelaporte.github.io&#x2F;BannerlordCoop-website&#x2F;docs&#x2F;main-concepts&#x2F;syncing&#x2F;">
      <div class="card my-1">
        <div class="card-body py-2">
          Syncing &rarr;
        </div>
      </div>
    </a>
  
</div>

      </main>
    </div>
  </div>
</div>


  
    
<footer class="footer text-muted">
	<div class="container">
		<div class="row">
			<div class="col-lg-8 order-last order-lg-first">
				<ul class="list-inline">
					
						<li class="list-inline-item">Powered by <a href="https://www.getzola.org/">Zola</a>, and <a href="https://github.com/aaranxu/adidoks">AdiDoks</a></li>
					
				</ul>
			</div>
			<div class="col-lg-8 order-first order-lg-last text-lg-end">
				<ul class="list-inline">
					
						
							<li class="list-inline-item"><a href="https://thomasdelaporte.github.io/BannerlordCoop-website/privacy-policy/">Privacy</a></li>
						
					
				</ul>
			</div>
		</div>
	</div>
</footer>

  

  
<script type="text/javascript" src="https://thomasdelaporte.github.io/BannerlordCoop-website/js/main.js" defer></script>

  <script type="text/javascript" src="https://thomasdelaporte.github.io/BannerlordCoop-website/plugins/elasticlunr.min.js" defer></script>
  <script type="text/javascript" src="https://thomasdelaporte.github.io/BannerlordCoop-website/search_index.en.js" defer></script>
  <script type="text/javascript" src="https://thomasdelaporte.github.io/BannerlordCoop-website/js/search.js" defer></script>

  
</body>
</html>
